version: '3.8'

services:
  victoriametrics:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: victoriametrics
    ports:
      - "8428:8428"
    volumes:
      - vmdata:/data
    environment:
      - RETENTION_PERIOD=1
      - SEARCH_LATENCY_OFFSET=30s
      - MAX_UNIQUE_TIMESERIES=300000
    command: >
      /victoria-metrics-prod
      -storageDataPath=/data
      -httpListenAddr=:8428
      -retentionPeriod=1
      -search.latencyOffset=30s
      -search.maxUniqueTimeseries=300000
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8428/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  vmagent:
    build:
      context: ./vmagent
      dockerfile: Dockerfile
    container_name: vmagent
    ports:
      - "8429:8429"
    environment:
      - SCRAPE_INTERVAL=15s
      - SCRAPE_TARGETS=
    depends_on:
      victoriametrics:
        condition: service_healthy
    # Override the entrypoint to use Docker hostname instead of railway.internal
    entrypoint: /bin/sh
    command:
      - -c
      - |
        mkdir -p /etc/vmagent
        cat > /etc/vmagent/scrape.yml <<EOF
        global:
          scrape_interval: $${SCRAPE_INTERVAL:-15s}
        scrape_configs:
          - job_name: 'vmagent'
            static_configs:
              - targets: ['localhost:8429']
          - job_name: 'victoriametrics'
            static_configs:
              - targets: ['victoriametrics:8428']
        EOF
        echo "vmagent starting with config:"
        cat /etc/vmagent/scrape.yml
        exec /vmagent-prod \
          -promscrape.config=/etc/vmagent/scrape.yml \
          -remoteWrite.url=http://victoriametrics:8428/api/v1/write \
          -httpListenAddr=:8429

  grafana:
    build:
      context: ./grafana
      dockerfile: Dockerfile
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=false
    volumes:
      - grafana-data:/var/lib/grafana
      # Override datasource to use Docker hostname
      - ./docker-compose-overrides/victoriametrics-local.yml:/etc/grafana/provisioning/datasources/victoriametrics.yml:ro
    depends_on:
      victoriametrics:
        condition: service_healthy

  auth-proxy:
    build:
      context: ./auth-proxy
      dockerfile: Dockerfile
    container_name: auth-proxy
    ports:
      - "8080:8080"
    environment:
      - API_KEY=test-api-key-change-me
    depends_on:
      victoriametrics:
        condition: service_healthy
    # Override entrypoint to use Docker hostname
    entrypoint: /bin/sh
    command:
      - -c
      - |
        cat > /etc/caddy/Caddyfile <<EOF
        {
            admin off
            auto_https off
        }
        :8080 {
            @valid_api_key header X-API-Key $${API_KEY}
            @valid_bearer header Authorization "Bearer $${API_KEY}"

            handle /health {
                respond "OK" 200
            }

            handle @valid_api_key {
                reverse_proxy http://victoriametrics:8428 {
                    header_up Host {upstream_hostport}
                    header_up X-Real-IP {remote_host}
                    header_up -X-API-Key
                }
            }

            handle @valid_bearer {
                reverse_proxy http://victoriametrics:8428 {
                    header_up Host {upstream_hostport}
                    header_up X-Real-IP {remote_host}
                    header_up -Authorization
                }
            }

            respond "Unauthorized" 401
        }
        EOF
        exec caddy run --config /etc/caddy/Caddyfile --adapter caddyfile

volumes:
  vmdata:
  grafana-data: